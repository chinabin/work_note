# 0x00. 导读

讲中断、时间中断。

# 0x01. 简介

# 0x02. 

中断贯穿着系统运行的始终，比如时钟中断为系统提供嘀嗒参考，供内核记录当前的时间，供调度统计器更新任务运行信息继而切换任务。

在目前 Intel 主流 CPU 架构中：IO APIC 连接在 IO 桥片上，统一接入处理器前端总线(比如 QPI)，每个处理器核心都有各自的 Local APIC (注意，每个物理 CPU 芯片内的每个核心都有独立的 Local APIC)，这些 Local APIC 与 IO APIC 之间通过 Ring/QPI 前端总线相互通信。图中右侧所示为老的P6处理器架构，其使用了独立的 APIC Bus，中断信号并不采用数据包的方式传输，而是直接在一个三根线组成的传统总线上传递。

![Alt text](image.png)

如图 10-163 左侧所示，APIC(包括 Local 和 I/O 一起)可以被整体禁用，而只使用传统的 8259A 中断控制器(俗称 PIC)，这些芯片的外围电路上都预留了对应的旁路设计，可以通过配置对应的寄存器来选择对应的模式，如果禁用APIC，则8259A的信号会被直接导通到处理器核心的INTR信号上，同时NMI中断信号也不会连接到 Local APIC 上，而是单独输出到一根线。当然，如果启用了APIC的同时也想继续使用8259A，那么后者必须连通到 I/O APIC 上作为一个级联的中断控制器，同时 NMI 信号也会从 Local APIC 中给出。这个模式的配置由系统IMCR(Interrupt Mode Configuration Register)寄存器中的对应位决定，改变这个位就可以控制上述两种模式的切换。

![Alt text](image-1.png)

如图 10-163 中间所示，在 MSI/MSI-X 中断方式中，中断信号变成一个访存请求发送给 CPU 上的 Local APIC，PCIE 设备先将访存请求发送给 PCIE 主控制器，后者再经过前端网络写到 Local APIC 上，这个过程是 Bypass I/O APIC 的。此外，处理器之间也可以直接发送 IPI(Inter Processor Interrupt) 中断。另外，在每个 Local APIC 内部会集成一个高分辨率的计时器 (High Resolusion Timer, HRTimer)。图 10-163 右侧所示为 Local APIC 与 I/O APIC 上的配置寄存器在系统物理地址空间中的位置。

如图 10-164 所示为 Local APIC (后简称 LAPIC ) 内部硬件架构图以及关键寄存器结构图。处理器芯片内的每个物理核心内部都有一些本地的I/O设备，比如计时器、各种性能计数器(比如缓存访问时延、流水线排空次数等，这些计数器被封装在 Performance Management Unit，PMU 内部)、各种环境传感器(温度/电压等)、本地错误状态寄存器(指 LAPIC 模块内部的错误)。其中，计时器和本地错误状态寄存器就位于 LAPIC 模块内部，其他的则处于 CPU 片内其他位置。这些核心内部的本地设备产生输出/警告时也需要发出中断。那么这些设备中断对应的中断号、中断向量、Vector 是多少呢？LAPIC 内部提供了一个 Local Vector Table(LVT)，软件( APIC 驱动程序)在系统初始化时可以向 LVT 中写入自定义的中断向量、中断触发模式等各种配置信息。当这些设备发出中断信号时，LAPIC 查询 LVT 中对应条目即可知道该中断的向量号是多少，要求怎样的触发模式(电平？边沿？)。LVT 内部结构见图 10-164 中间(桃红色标记)。LAPIC 还预留了 LINT0/1 这两个额外的信号用于接入其他可能的设备。

针对外部(比如从 I/O APIC，或者来自 PCIE 主控制器的 MSI/MSI-X 消息)发来的中断信号，LAPIC 内部(右下角)的 Protocol Translation Logic 会负责从外部总线上 (Ring/Mesh 前端总线，或者传统的 3 导线 APIC Bus) 将 IO APIC 发来的中断消息(内含中断向量号、中断传送模式、LAPIC的地址等信息)收入并分析然后做出动作。

总结一下，核心内部本地设备发出的中断，LAPIC 从 LVT 中获取中断向量；外部设备发出的中断，LAPIC 直接从外部总线上拿到中断向量。中断向量是一个8位的值，因为 x86 CPU 最大支持256个向量。LAPIC 将对应的中断向量做转换展开，比如 向量=0xAA，其十进制值是170，则展开成256个位，第170个位为1，其他都为0。然后将这个1写入到 IRR 寄存器(256位长)中的第170位上，以表示“170号向量对应的中断正等待发送到CPU核心”。由于外部设备发出中断信号的时机不确定，所以只要LAPIC收到了信号，就将对应向量写入 IRR 等候处理，假设所有255个向量对应的设备同时发出中断，那么IRR中将全为1，然而这是不可能发生的场景。

之后，LAPIC 会根据中断的优先级(数值越大越高)从IRR中找出最高位的位，将其写入ISR中对应的位，同时清零IRR中对应的位，然后向CPU核心发出中断信号。也就是说，IRR中保存的是已经被LAPIC接纳但是还没有开始执行的中断：ISR中保持的是当前正在执行但是还没有完成的中断。CPU核心会从ISR中读取对的向量然后根据由内核初始化的中断向量表查到对应的中断服务程序入口执行。中断返回后，中断服务程序需要对EOI寄存器做次写操作，LAPIC便知道本次中断处理完成，于是清零ISR中对应的位。

如果 LAPIC 收到的是 NMI/SMI/INIT/ExtINT 类型的中断，则不让其等候在IRR和ISR中，而是直接发送给CPU核心。因为这些中断都是需要紧急处理的，其中，NMI为不可屏蔽中断，INIT为与电源加电/掉电相关的中断，SMI 是 SystemManagement Interrupt，与系统管理相关的中断。ExtINT 为对传统 8259A PIC 的模拟。

![Alt text](image-2.png)

下图为 LAPIC 中关键寄存器的作用一览。
中断的优先级=中断向量/16 取余，也就相当于右移 4 位，也就是优先级=中断向量的高4位，共16级优先级。同时由于 0~31 号中断向量被 CPU 保留，其优先级为 1 所以用于其他设备的优先级范围是 2~15。TPR 寄存器可以被软件写入一个优先级值，凡是发生低于这个值的中断( NMI/INIT/SMI/ExtINT 中断不受其限制)，LAPIC 并不向CPU核心发送，但是依然被记录到 IRR 中待命。这可以让软件获得充分的灵活性，比如当前如果正在执行个关键任务，不想被优先级低于xx的中断打断，就可以设置 TPR 寄存器来实现。而 PPR 寄存器中保存的是当前 CPU 核心正在执行的任务的最高优先级，其值为 maximum{TRR值，ISR中最高优先级}。当 LAPIC 收到某个中断请求时，会根据 PPR 的当前值判断是否要把刚收到的中断请求发送给 CPU ，如果刚收到的中断优先级高于 PPR 中的则发送，如果小于则不发送。也就是说，内核希望高于 TPR 优先级的中断可以进 CPU，但是如果来了一个优先级比 TPR 高但是低于 PPR 的中断，LAPIC 也不能将其发送给 CPU，只能先在 IRR 中等候。

![Alt text](image-3.png)

再来看看 IO APIC。如下图所示为 Intel 82093AA IO APIC 与 LAPIC 连接拓扑细节图，该系统为老一代系统，其中，PIIX3 为兼容 ISA 总线设备而保留的中断控制器，I/O APIC 上也有一些配置寄存器，其通过 PCI 总线连接到系统中，将这些寄存器纳入地址空间中可供配置，同时另一侧则使用 APIC 总线与 LAPIC 互连。APIC 之间采用3线的专用 APIC 总线互连，APIC 总线的三根导线分别为:时钟线、数据线#1和#2。图中右侧所示分别为 I/O APIC 向 LAPIC 发送的一条中断消息和 LAPIC 向 I/O APIC 发送的一条 EOI 消息(对于电平型中断，中断结束后 LAPIC 发送 EOI 消息给 I/O APIC 通告处理完成)在该总线上的传递时序。由于只有两根数据线，每周期只能传递2位的数据。对于新架构的系统，APIC 之间会采用数据包的方式，利用 Ring/Mesh 等前端访存网络互相传递数据。

![Alt text](image-4.png)