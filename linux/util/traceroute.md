# 0x00. 导读

yum install traceroute


# 0x01. 简介

traceroute 用于追踪数据包在网络上的传输时的全部路径，它默认发送的数据包大小是 40 字节。

通过 traceroute 可以知道信息从你的计算机到另一端的主机是走的什么路径。当然每次数据包由某一同样的出发点 (source) 到达某一同样的目的地 (destination) 走的路径可能会不一样，但基本上来说大部分时候所走的路由是相同的。

traceroute 命令利用 IP 协议的 ttl 字段，并尝试从每个网关到某个主机的路径引发 ICMP TIME_EXCEEDED 响应。

traceroute 尝试通过启动具有较小 ttl（生存时间）的探测数据包，然后侦听来自网关的 ICMP “超过时间” 答复来跟踪 IP 数据包将遵循的路由到某些 Internet 主机的路由。它以 1 的 ttl 开始其探测，并将其增加 1，直到获得 ICMP “端口不可达”（或 TCP 重置），这意味着我们到达了“主机”，或者达到了最大值（默认为 30 跳）...在每个 ttl 设置下发送三个探针（默认情况下），并打印一行以显示 ttl，网关地址和每个探针的往返时间。如果探测答案来自不同的网关，则将打印每个响应系统的地址。如果在 5.0 秒内（默认）没有响应，则为该探针打印一个 “*”（星号）。

IP 包每经过一跳路由， TTL 减一；当 TTL 减到零，路由器便将它丢弃。  
路由器在将超时包丢弃的同时，负责向源 IP 发送一个 ICMP 报文，报告 传输超时 （ time to live exceeded in transit ）错误，ICMP 类型为 11 。

# 0x02. 实例

```bash
$ traceroute www.58.com
traceroute to www.58.com (211.151.111.30), 30 hops max, 40 byte packets
 1  unknown (192.168.2.1)  3.453 ms  3.801 ms  3.937 ms
 2  221.6.45.33 (221.6.45.33)  7.768 ms  7.816 ms  7.840 ms
 3  221.6.0.233 (221.6.0.233)  13.784 ms  13.827 ms 221.6.9.81 (221.6.9.81)  9.758 ms
 4  221.6.2.169 (221.6.2.169)  11.777 ms 122.96.66.13 (122.96.66.13)  34.952 ms 221.6.2.53 (221.6.2.53)  41.372 ms
 5  219.158.96.149 (219.158.96.149)  39.167 ms  39.210 ms  39.238 ms
 6  123.126.0.194 (123.126.0.194)  37.270 ms 123.126.0.66 (123.126.0.66)  37.163 ms  37.441 ms
 7  124.65.57.26 (124.65.57.26)  42.787 ms  42.799 ms  42.809 ms
 8  61.148.146.210 (61.148.146.210)  30.176 ms 61.148.154.98 (61.148.154.98)  32.613 ms  32.675 ms
 9  202.106.42.102 (202.106.42.102)  44.563 ms  44.600 ms  44.627 ms
10  210.77.139.150 (210.77.139.150)  53.302 ms  53.233 ms  53.032 ms
11  211.151.104.6 (211.151.104.6)  39.585 ms  39.502 ms  39.598 ms
12  211.151.111.30 (211.151.111.30)  35.161 ms  35.938 ms  36.005 ms
```

记录按序列号从1开始，每个纪录就是一跳 ，每跳表示一个网关，我们看到每行有三个时间，单位是 ms 。探测数据包向每个网关发送三个数据包后，网关响应后返回的时间；如果用 `traceroute -q 4 www.58.com` ，表示向每个网关发送4个数据包。

有时我们 traceroute 一台主机时，会看到有一些行是以 **星号** 表示的。出现这样的情况，可能是防火墙封掉了 ICMP 的返回信息，所以我们得不到什么相关的数据包返回数据。

有时我们在某一网关处延时比较长，有可能是某台网关比较阻塞，也可能是物理设备本身的原因。当然如果某台 DNS 出现问题时，不能解析主机名、域名时，也会 有延时长的现象；您可以加 `-n` 参数来避免 DNS 解析，以 IP 格式输出数据。
