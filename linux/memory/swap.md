# 0x00. 导读

# 0x01. 简介

# 0x02. 

Linux 下有两种类型的 swap 空间，swap 分区和 swap 文件，它们有各自的特点：

- swap 分区

    - swap 分区上面由于没有文件系统，所以相当于内核直接访问连续的磁盘空间，效率相对要高点，但由于 swap 分区一般安装系统时就分配好了，后期要缩减空间和扩容都很不方便。

- swap 文件

    - swap 文件放在指定分区的文件系统里面，所以有可能受文件系统性能的影响，但据说2.6版本以后的内核可以直接访问swap文件对应的物理磁盘地址，相当于跳过了文件系统直接访问磁盘。不过如果 swap 文件在磁盘上的物理位置不连续时，还是会对性能产生不利影响，但其优点就是灵活，随时可以增加和移除swap文件。

```bash
# 查看系统中已经配置的 swap 分配情况

# Filename: 类型是分区则显示分区路径，类型是文件则显示文件路径
# Type: partition代表是一个swap分区，file代表是一个swap文件
# Size: 显示swap的大小，默认单位是KB
# Used: 已经被使用的大小，0表示还没有被使用到
# Priority: 优先级高将会被优先使用，同等优先级将会均匀使用(设置: swapon -p)
escape@app:~$ swapon -s
Filename             Type      Size        Used       Priority
/data/.swapfile      file      10485756    6534248    -1
/data1/.swapfile     file      10485756    3246088    -2
```

注意：
- 并不是swap空间占用多就一定性能下降
- 真正影响性能是 swap in 和 out 的频率，频率越高对系统的性能影响越大

# 0x03. 优化 swap 性能

怎么配置 swap 可以让它的性能更好呢？

- 尽量使用 swap 分区，相对于 swap 文件来说，分区肯定是连续的物理磁盘空间，而 swap 文件有可能不是。

- 将 swap 分区和系统所在的分区放在不同的磁盘上，这样就不会和系统盘抢同一个磁盘的 I/O 带宽。

- 如果有多块磁盘的话，可以在每个盘上创建一个 swap 分区，并且将它们的优先级设置的一样，这样内核就会平均的访问这些 swap 分区，性能相当于原来的 N 倍(这里 N 是磁盘的数量)。

不过话又说回来了，如果频繁的访问 swap 的话，怎么优化 swap 都没用，跟内存比还是低几个数量级，性能还是下降的厉害，如果不频繁访问 swap 的话，优化 swap 又有啥意义呢？所以其实优化 swap 性能的实际意义不大，这里了解一下就好

## 3.1 配置 swappiness 特性

**配置希望尽量减少 Swap 空间的使用！**

有时我们桌面环境确实配置了比较充裕的内存，并且也配置了 swap 空间，这个时候就希望尽量减少 swap 空间的使用，避免对系统性能造成影响。Linux 早就帮我们考虑到这种情况了，在 2.6 内核中，增加了一个叫做 swappiness 的参数，用于配置需要将内存中不常用的数据移到 swap 中去的紧迫程度。这个参数的取值范围是 0～100，0 告诉内核尽可能的不要将内存数据移到 swap 中，也即只有在迫不得已的情况下才这么做，而 100 告诉内核只要有可能，尽量的将内存中不常访问的数据移到 swap 中。

默认 60.

```bash
# 修改当前系统中swappiness的值
$ sudo sysctl vm.swappiness=10
vm.swappiness = 10

# 查看当前系统中swappiness的值
$ sudo cat /proc/sys/vm/swappiness
10

# 生效配置 => /etc/sysctl.conf
$ sudo /sbin/sysctl -p
```

上面通过 sysctl 修改的 swappiness 值在系统重启后会失效，要想重启后继续生效，需要修改配置文件 /etc/sysctl.conf，将下面这行修改成 10，如果文件中找不到这行的话，在文件末位加上这行就可以了。

```
vm.swappiness=10
```