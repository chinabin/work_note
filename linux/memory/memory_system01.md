# 0x00. 导读

# 0x01. 简介

对于 **物理地址空间** 而言，可以分为三个层级：节点(`node`)、管理区(`zone`)、页面(`page`) ，类似国家的省、县、乡。

# 0x02. 物理地址空间

## 2.1 NODE

UMA 只有一个节点， NUMA 可以有多个节点。

```bash
$ ls /sys/devices/system/node/node*
/sys/devices/system/node/node0:
...

/sys/devices/system/node/node1:
...
```

## 2.2 ZONE

物理内存（注意， ZONE 是物理内存上的概念）划分了六个 ZONE 。

```bash
$ cat /proc/zoneinfo | grep zone
Node 0, zone      DMA
Node 0, zone    DMA32
Node 0, zone   Normal
Node 1, zone   Normal
```

**除了第一个节点( Node 0 )能包含所有的区域类型之外，其它的节点并不能包含所有的区域类型，因为有些区域类型( DMA、DMA32 )必须从物理内存的起点开始。**

1. ZONE_DMA  
    - 由配置项 CONFIG_ZONE_DMA 决定是否存在。
    - 在 x86 上 DMA 内存区域是物理内存的前 `16M` ，这是因为早期的 ISA 总线上的 DMA 控制器只有 24 根地址总线，只能访问 16M 物理内存。为了兼容这些老的设备，所以需要专门开辟前 16M 物理内存作为一个区域供这些设备进行DMA操作时去分配物理内存。
    - 该区域的物理页面专门供 I/O 设备的 DMA 使用。之所以需要单独管理 DMA 的物理页面，是因为 DMA 使用物理地址访问内存，不经过 MMU ，并且需要连续的缓冲区，所以为了能够提供物理上连续的缓冲区，必须从物理地址空间专门划分一段区域用于 DMA 。

        DMA 技术就是我们在主板上放一块独立的芯片。在进行内存和 I/O 设备的数据传输的时候，我们不再通过 CPU 来控制数据传输，而直接通过 DMA 控制器（DMA Controller，简称 DMAC）。这块芯片，我们可以认为它其实就是一个协处理器（Co-Processor）。

2. ZONE_DMA32   
    - 由配置项 CONFIG_ZONE_DMA32 决定是否存在。
    - 后来的 DMA 控制器有 32 根地址总线，可以访问 4G 物理内存了。但是在 32 位的系统上最多只支持 4G 物理内存，所以没必要专门划分一个区域。但是到了 64 位系统时候，很多CPU能支持 48 位到 52 位的物理内存，于是此时就有必要专门开个区域给 32 位的 DMA 控制器使用了。

3. `ZONE_NORMAL`   
    - 常规内存，无配置项控制，必然存在。 16~896M.

4. `ZONE_HIGH`   
    - 由配置项 CONFIG_HIGHMEM 决定是否存在。
    - **只在 32 位系统上有**，因为内核的虚拟地址空间只有 1GB ，但它需要访问整个 4GB 的物理空间:
        - 从物理地址 `0 ~ 896MB` 的部分 (`ZONE_DMA+ZONE_NORMAL`) ，直接加上 `3GB` 的偏移（在 Linux 中用 `PAGE_OFFSET` 表示），就得到了对应的虚拟地址 (`3G ~ 3G+896M`)，这种映射方式被称为 **线性/直接映射** (`Direct Map`) 。

        - 而 `896M ~ 物理地址尽头` 的物理地址部分 (`ZONE_HIGH`) 需要映射到 `3G+896M ~ 4GB` 这 `128MB` 的虚拟地址空间，显然也按线性映射是不行的。

            采用的是做法是，ZONE_HIGH 中的某段物理内存和这 128M 中的某段虚拟空间建立映射，完成所需操作后，断开与这部分虚拟空间的映射关系，以便 ZONE_HIGHMEM 中其他的物理内存可以继续往这个区域映射，即 **动态映射** 的方式。

        - 对于 **虚拟地址空间**，`0 ~ 3G` 是用户空间，`3G ~ 3G + 896Mb` 称为 `LowMem`  （低端内存），`3G + 896 Mb ~ 4G` 称为 `HighMem` （高端内存） 。

5. ZONE_MOVABLE   
    - 可移动内存，无配置项控制，必然存在，用于可热插拔的内存。
    - 内核启动参数 movablecore 用于指定此区域的大小。内核参数 kernelcore 也可用于指定非可移动内存的大小，剩余的内存都是可移动内存。如果两者同时指定的话，则会优先保证非可移动内存的大小至少有 kernelcore 这么大。如果两者都没指定，则可移动内存大小为 0 。

6. ZONE_DEVICE   
    - 设备内存，由配置项 CONFIG_ZONE_DEVICE 决定是否存在，用于放置持久内存(也就是掉电后内容不会消失的内存)。
    - 一般的计算机中没有这种内存，默认的内存分配也不会从这里分配内存。持久内存可用于内核崩溃时保存相关的调试信息。

