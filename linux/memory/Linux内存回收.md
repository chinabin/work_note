# 0x0 导读

# 0x01、简介

内存作为系统最宝贵的资源，总是不够用的。当内存不足的时候就要对内存进行回收了。内存回收按照回收时机可以分为同步回收和异步回收：
- 同步回收是指在分配内存的时候发现无法分配到内存就进行回收
- 异步回收是指有专门的线程定期进行检测，如果发现内存不足就进行回收。

内存回收的类型有两种：
- 一是内存规整，也就是内存碎片整理，它不会增加可用内存的总量，但是会增加连续可用内存的量
- 二是页帧回收，它会把物理页帧的内容写入到外存中去，然后解除其与虚拟内存的映射，这样可用物理内存的量就增加了。

同步回收和异步回收都会使用内存规整和页帧回收。  

在异步回收中，内存规整有单独的线程 `kcompactd` ，此类线程一个 NODE 一个，线程名是 `[kcompactd/nodeid]` ，页帧回收也有单独的线程 `kswapd` ，此类线程也是一个 NODE 一个，线程名是 `[kswapd/nodeid]` 。在同步回收中，还有一个大杀器，那就是 `OOM Killer` 。

进程的内存页分为两种类型：
- 文件页，其内容来源于文件，如程序的代码区、数据区；
    - 文件页是 clean 的
        - 也就是和外存中的内容是一样的，此时我们可以直接丢弃文件页，后面用到时再从外存中加载进来；
    - 文件页是 dirty 的
        - 也就是其经历过修改，和外存中的内容不同，此时要先把文件页的内容写入到外存中，然后才能回收其内存
- 匿名页，没有内容来源，由内核直接为其分配内存，如进程的堆和栈。
    - 由于其没有文件做后备，没办法对其进行回收。此时就需要swap作为匿名页的后备存储了，有了 swap 之后，匿名页也可以进行回收了。 Swap 是外存中的一片空间，可以是一个分区，也可以是文件。

