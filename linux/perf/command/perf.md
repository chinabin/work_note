# 简介

ftrace 的跟踪方法是一种总体跟踪法，换句话说，你统计了一个事件到下一个事件所有的时间长度，然后把它们放到时间轴上，你可以知道整个系统运行在时间轴上的分布。

这种方法很准确，但跟踪成本很高。所以，我们也需要一种抽样形态的跟踪方法。 perf 提供的就是这样的跟踪方法。

perf的原理是这样的：每隔一个固定的时间，就在CPU上（每个核上都有）产生一个中断，在中断上看看，当前是哪个pid，哪个函数，然后给对应的pid和函数加一个统计值，这样，我们就知道CPU有百分几的时间在某个pid，或者某个函数上了。

1. Perf工具支持一系列的可测量事件。利用 PMU(Performance Monitor Unit) 、 tracepoint 和内核中的计数器来进行性能统计。可以用 perf list 查看完整的。

2. 事件可以分为如下三种：
    - Hardware Event 由 PMU 部件产生，在特定的条件下探测性能事件是否发生以及发生的次数。比如 cache 命中

    - Software Event 是内核产生的事件，分布在各个功能模块中，统计与操作系统相关的性能事件。比如进程切换、tick数等

    - Tracepoint Event 是内核中静态 tracepoint 所触发的事件，这些 tracepoint 用来判断程序运行期间内核的行为细节，比如slab分配器的分配次数等。

3. 一个事件可以有子事件(或掩码)。 在某些处理器上的某些事件，可以组合掩码，并在其中一个子事件发生时进行测量。最后，一个事件还可以有修饰符，也就是说，通过过滤器可以改变事件被计数的时间或方式。

    事件可以通过冒号添加一个或多个修饰符。 修饰符允许用户对事件计数进行限制。   
    `perf stat -e cycles:u dd if=/dev/zero of=/dev/null count=100000`

缺点：
1. 引入了哪些负荷？

----- 

## tracepoints

tracepoints 是散落在内核源代码中的一些 hook ，它们可以在特定的代码被执行到时触发。

`sudo ls /sys/kernel/debug/tracing/events`

